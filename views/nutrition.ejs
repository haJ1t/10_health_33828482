<%- include('partials/header') %>
<%- include('partials/nav') %>

<main class="main-content">
    <section class="nutrition-section">
        <div class="page-header">
            <h1><i class="fas fa-utensils"></i> My Nutrition</h1>
            <div class="header-actions">
                <a href="<%= basePath %>/nutrition/add" class="btn btn-primary">
                    <i class="fas fa-plus"></i> Add Meal
                </a>
            </div>
        </div>
        
        <% if (error) { %>
            <div class="alert alert-error">
                <i class="fas fa-exclamation-circle"></i>
                <%= error %>
            </div>
        <% } %>
        
        <% if (nutrition && nutrition.length > 0) { %>
            <!-- Weekly Summary (Advanced SQL - Aggregation) -->
            <% if (summary && summary.length > 0) { %>
                <div class="nutrition-summary">
                    <h2>7-Day Summary</h2>
                    <canvas id="nutritionChart" width="400" height="200"></canvas>
                    
                    <div class="summary-cards">
                        <% summary.forEach(day => { %>
                            <div class="summary-card">
                                <h4><%= new Date(day.day).toLocaleDateString() %></h4>
                                <div class="summary-stats">
                                    <div class="stat">
                                        <span class="stat-label">Calories</span>
                                        <span class="stat-value"><%= Math.round(day.total_calories) %></span>
                                    </div>
                                    <div class="stat">
                                        <span class="stat-label">Protein</span>
                                        <span class="stat-value"><%= Math.round(day.total_protein) %>g</span>
                                    </div>
                                    <div class="stat">
                                        <span class="stat-label">Carbs</span>
                                        <span class="stat-value"><%= Math.round(day.total_carbs) %>g</span>
                                    </div>
                                    <div class="stat">
                                        <span class="stat-label">Fat</span>
                                        <span class="stat-value"><%= Math.round(day.total_fat) %>g</span>
                                    </div>
                                </div>
                            </div>
                        <% }) %>
                    </div>
                </div>
            <% } %>
            
            <!-- Nutrition List -->
            <div class="nutrition-list">
                <h2>All Meals (<%= nutrition.length %>)</h2>
                
                <div class="table-responsive">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Meal</th>
                                <th>Type</th>
                                <th>Calories</th>
                                <th>Protein</th>
                                <th>Carbs</th>
                                <th>Fat</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% nutrition.forEach(meal => { %>
                                <tr>
                                    <td><%= new Date(meal.date).toLocaleDateString() %></td>
                                    <td><strong><%= meal.meal_name %></strong></td>
                                    <td>
                                        <span class="badge badge-<%= meal.meal_type %>">
                                            <%= meal.meal_type %>
                                        </span>
                                    </td>
                                    <td><%= meal.calories %></td>
                                    <td><%= meal.protein_grams ? meal.protein_grams + 'g' : '-' %></td>
                                    <td><%= meal.carbs_grams ? meal.carbs_grams + 'g' : '-' %></td>
                                    <td><%= meal.fat_grams ? meal.fat_grams + 'g' : '-' %></td>
                                    <td>
                                        <form action="<%= basePath %>/nutrition/delete/<%= meal.id %>" method="POST" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete this meal?');">
                                            <button type="submit" class="btn btn-danger btn-sm">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </form>
                                    </td>
                                </tr>
                            <% }) %>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Chart.js Script -->
            <script>
                const summaryData = <%- JSON.stringify(summary) %>;
                
                const ctx = document.getElementById('nutritionChart').getContext('2d');
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: summaryData.map(d => new Date(d.day).toLocaleDateString()),
                        datasets: [{
                            label: 'Calories',
                            data: summaryData.map(d => d.total_calories),
                            borderColor: 'rgba(255, 99, 132, 1)',
                            backgroundColor: 'rgba(255, 99, 132, 0.2)',
                            tension: 0.3
                        }, {
                            label: 'Protein (g)',
                            data: summaryData.map(d => d.total_protein),
                            borderColor: 'rgba(54, 162, 235, 1)',
                            backgroundColor: 'rgba(54, 162, 235, 0.2)',
                            tension: 0.3
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            </script>
        <% } else { %>
            <div class="empty-state">
                <i class="fas fa-utensils empty-icon"></i>
                <h2>No meals logged yet</h2>
                <p>Start tracking your nutrition by adding your first meal!</p>
                <a href="<%= basePath %>/nutrition/add" class="btn btn-primary btn-large">
                    <i class="fas fa-plus"></i> Add Your First Meal
                </a>
            </div>
        <% } %>
    </section>
</main>

<%- include('partials/footer') %>
